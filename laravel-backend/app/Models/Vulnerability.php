<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

class Vulnerability extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'vulnerability_asset_id',
        'title',
        'description',
        'severity',
        'cvss_score',
        'cve_reference',
        'exploitability',
        'status',
        'affected_component',
        'remediation',
        'assigned_to',
        'discovered_at',
        'resolved_at',
        'impact_availability',
        'impact_confidentiality', 
        'impact_integrity'
    ];

    protected $casts = [
        'discovered_at' => 'datetime',
        'resolved_at' => 'datetime',
        'cvss_score' => 'decimal:1',
    ];

    public function asset()
    {
        return $this->belongsTo(VulnerabilityAsset::class, 'vulnerability_asset_id');
    }

    public function assignedUser()
    {
        return $this->belongsTo(User::class, 'assigned_to');
    }

    public function getCvssRatingAttribute()
    {
        if ($this->cvss_score >= 9.0) return 'Critical';
        if ($this->cvss_score >= 7.0) return 'High';
        if ($this->cvss_score >= 4.0) return 'Medium';
        return 'Low';
    }

    public function scopeOpen($query)
    {
        return $query->where('status', 'open');
    }

    public function scopeCritical($query)
    {
        return $query->where('severity', 'critical');
    }
}